{% block content %}
{% load static %}

{% csrf_token %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Calculator</title>

    <!-- Google Web Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,400;0,700;0,900;1,400;1,700;1,900&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet"> 

    <!-- Icon Font Stylesheet -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="{% static 'img/c7_logo.png'%}">

    <!-- Libraries Stylesheet -->
    <link href="{% static 'lib/animate/animate.min.css'%}" rel="stylesheet">
    <link href="{% static 'lib/owlcarousel/assets/owl.carousel.min.css'%}" rel="stylesheet">


    <!-- Customized Bootstrap Stylesheet -->
    <link href="{% static 'css/bootstrap.min.css'%}" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="{% static 'css/style.css'%}" rel="stylesheet">
</head>
<body>

    <!-- Spinner Start -->
    <div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-border" style="width: 3rem; height: 3rem;color:#e30a23" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
    <!-- Spinner End -->

    <!-- Topbar Start -->
    <div class="container-fluid topbar d-none d-xl-block w-100" style="background:#ffffff;">
        <div class="container">
            <div class="row gx-0 align-items-center" style="height: 45px;">
                <div class="col-lg-6 text-center text-lg-start mb-lg-0">
                    <div class="d-flex flex-wrap">
                        <a class="text-muted me-4"><i class="fas fa-phone-alt me-2" style="color: #e30a23;"></i>+971562341000</a>
                        <a class="text-muted me-0"><i class="fas fa-envelope me-2" style="color: #e30a23;"></i>Csev7motors@gmail.com</a>
                    </div>
                </div>
                <div class="col-lg-6 text-center text-lg-end">
                    <div class="d-flex align-items-center justify-content-end">
                        <a href="https://www.tiktok.com/@_c7motors" class="btn btn-light btn-sm-square rounded-circle me-3"><i class="fab fa-tiktok"></i></a>
                        <a href="https://www.instagram.com/c.7.motors/" class="btn btn-light btn-sm-square rounded-circle me-3"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Topbar End -->

    <!-- Navbar & Hero Start -->
    <div class="container-fluid nav-bar sticky-top px-0 px-lg-4 py-2 py-lg-0">
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-light">
                <a href="{% url 'c7_motors:home' %}" class="navbar-logo p-0">
                    <img src="{% static 'img/c7_logo.png'%}" alt="">
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                    <span class="fa fa-bars"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <div class="navbar-nav mx-auto mt-3 py-0">
                        <a href="{% url 'c7_motors:home' %}" class="nav-item nav-link"><i class="bi bi-house-door"></i> Home</a>
                        <a href="{% url 'c7_motors:about' %}" class="nav-item nav-link"><i class="bi bi-info-circle"></i> About</a>
                        <a href="{% url 'c7_motors:service' %}" class="nav-item nav-link"><i class="bi bi-tools"></i> Service</a>
                        <a href="{% url 'c7_motors:feature' %}" class="nav-item nav-link"><i class="bi bi-star-fill"></i> Features</a>
                        <a href="{% url 'c7_motors:shopping_cart' %}" class="nav-item nav-link"><i class="bi bi-basket3"></i> My Cart</a>
                        <a href="" class="nav-item nav-link" id="checkout-button" data-bs-toggle="modal" data-bs-target="#exampleModal"><i class="bi bi-cash"></i> Pay</a>
                        <a href="{% url 'c7_motors:contact_us' %}" class="nav-item nav-link"><i class="bi bi-telephone"></i> Contact</a>
                    </div>
                    {% if user.is_authenticated %}
                    <form action="/log_out/" method="post" class="main_nav">
                     {% csrf_token %}
                     <a class="btn rounded-pill" style="background-color: #e30a23;"><button type="submit" class="btn" style="color: #ffffff;">Log out</button></a>
                    </form>
                    {% else %}
                    <a class="btn rounded-pill mx-3" style="background-color: #e30a23;" href="{% url 'c7_motors:log_in'%}"><button type="submit" class="btn" style="color: #ffffff;">Log in</button></a>
                    <a class="btn rounded-pill" style="background-color: #e30a23;" href="{% url 'c7_motors:sign_in'%}" style="margin-left: 20px;"><button type="submit" class="btn" style="color: #ffffff;">Sign in</button></a>
                    {% endif %}
                </div>
            </nav>
        </div>
    </div>
    <!-- Navbar & Hero End -->
    
    <!-- Calculater Start -->
    <section style="background-color: #eee;">
        <div class="container py-5">
          <div class="card">
            <div class="card-body">
              <div class="row d-flex justify-content-center pb-5">
                <div class="col-md-7 col-xl-5 mb-4 mb-md-0">
                  <div class="py-4 d-flex flex-row">
                    <h5><span class="far fa-check-square pe-2"></span><b>Salary Calculater</b> |</h5>
                    <span class="ps-2">C7 Motors</span>
                  </div>
                  {% for item in items %}
                    <div class="col-12 input-group mb-4">
                        <input value="{{ item.car.brand_name }} {{ item.car.model }}" id="cars" name="cars" class="form-select rounded-end" style="padding-right:0%;background-image: none;" readonly>
                        <i data-car-id="{{ item.car.id }}" style="color: #e30a23;" class="btn delete_item fas fa-trash"></i>
                    </div>
                  {% endfor %}
                  <div class="col-12 form-group mb-4">
                    <input  id="salary"  class="form-select" style="background-image: none;" name="salary" placeholder="Your Salary" required>
                </div>

                <div class="col-12 form-group mb-4">
                    <div class="input-group">
                        <div class="d-flex align-items-center bg-light text-body rounded-start p-2">
                            <span class="fas fa-passport"></span><span class="ms-1">Salary Bank</span>
                        </div>
                        <select name="salary_bank" class="form-select" style="background-image: none;" required>
                            <option value="دبي الاسلامي">دبي الاسلامي</option>
                            <option value="ابو ظبي الاسلامي ADIB">ابو ظبي الاسلامي ADIB</option>
                            <option value="ابو ظبي الاول FAB">ابو ظبي الاول FAB</option>
                            <option value="ابو ظبي التجاري ADCB">ابو ظبي التجاري ADCB</option>
                            <option value="بنك المشرق">بنك المشرق</option>
                            <option value="الامارات الاسلامي">الامارات الاسلامي</option>
                            <option value="بنك الامارات دبي الوطني NBD">بنك الامارات دبي الوطني NBD</option>
                            <option value="another">another</option>
                        </select>  
                    </div>
                </div>

                <div class="col-12 form-group mb-4">
                    <div class="input-group">
                        <div class="d-flex align-items-center bg-light text-body rounded-start p-2">
                            <span class="fas fa-passport"></span><span class="ms-1">Monthly Payments Bank</span>
                        </div>
                        <select name="monthly_payments_bank" class="form-select" style="background-image: none;" required>
                            <option value="دبي الاسلامي">دبي الاسلامي</option>
                            <option value="ابو ظبي الاسلامي ADIB">ابو ظبي الاسلامي ADIB</option>
                            <option value="ابو ظبي الاول FAB">ابو ظبي الاول FAB</option>
                            <option value="ابو ظبي التجاري ADCB">ابو ظبي التجاري ADCB</option>
                            <option value="بنك المشرق">بنك المشرق</option>
                            <option value="الامارات الاسلامي">الامارات الاسلامي</option>
                            <option value="بنك الامارات دبي الوطني NBD">بنك الامارات دبي الوطني NBD</option>
                        </select>  
                    </div>
                </div>

                <div class="col-12 form-group mb-4">
                    <div class="input-group">
                        <div class="d-flex align-items-center bg-light text-body rounded-start p-2">
                            <span class="fas fa-id-badge"></span><span class="ms-1">Nationality</span>
                        </div>
                        <select name="nationality" class="form-select" style="background-image: none;"  placeholder="nationality" required>
                            <option value="Emirati">Emirati</option>
                            <option value="Another Nationality">Another Nationality</option>
                        </select>  
                    </div>
                </div>
                  <hr />
                  <div class="pt-2">
                    <p>
                        If you pay deposit , 
                        a request will be submitted to the bank, 
                        and in case of rejection, the deposit will not be refunded
                    </p>
                    <div class="buttons row">
                        <button id="pay_deposit" class="calculate btn btn-primary btn-block btn-md col mx-3">Pay Downpayment</button>
                        <button id="continue_without_dp" class="clear btn btn-primary btn-block btn-md col">Continue Without Downpayment</button>
                    </div>
                  </div>
                </div>
      
                <div class="col-md-5 col-xl-4 offset-xl-1">
                  <div class="rounded d-flex flex-column p-2 bg-body-tertiary">
                    <div class="p-2 me-3">
                      <h4>Overview</h4>
                    </div>
                    <div class="p-2 d-flex">
                      <div class="col-8">Downpayment</div>
                      <div class="ms-auto" id="downpayment">AED 0.00</div>
                    </div>
                    <div class="p-2 d-flex">
                      <div class="col-8">Annual interest rate</div>
                      <div class="ms-auto" id="annual_interest_rate">AED 0.00</div>
                    </div>
                    <div class="p-2 d-flex">
                        <div class="col-8">Monthly installment with downpayment</div>
                        <div class="ms-auto" id="monthly_installment_with_downpayment">AED 0.00</div>
                      </div>
                    <div class="p-2 d-flex">
                      <div class="col-8">Monthly installment without downpayment</div>
                      <div class="ms-auto" id="monthly_installment_without_downpayment">AED 0.00</div>
                    </div>
                    <div class="border-top px-2 mx-2"></div>
                    <div class="p-2 d-flex pt-3">
                      <div class="col-8"><b>Total with downpayment</b></div>
                      <div class="ms-auto"><b class="text-success" id="total_with_dp">AED 0.00</b></div>
                    </div>
                    <div class="p-2 d-flex pt-3">
                        <div class="col-8"><b>Total without downpayment</b></div>
                        <div class="ms-auto"><b class="text-success" id="total_without_dp">AED 0.00</b></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        //Delete Items In The Customer Shopping Cart
        let delete_button = document.querySelectorAll('.delete_item')
        delete_button.forEach(btn => {
            btn.addEventListener('click' , deleteItem)
        })
        function deleteItem(e){
            let car_id = e.target.dataset.carId
            let url = '/delete/'
            let data = { id:car_id }
            
            fetch(url , {
                method : 'POST' ,
                headers : {"Content-Type" : "application/json" , "X-CSRFToken" : csrftoken} ,
                body : JSON.stringify(data)
            }).then(res => res.json())
            .then(data => {
                console.log(data)
            })
            .catch(error => {
                console.log(error)
            })
        }

        // CSRF token helper 
        function getCSRFToken() {
            let cookieValue = null;
            const name = 'csrftoken';
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Function to update salary overview dynamically
        function updateSalaryOverview(action) {
            const salary = $('#salary').val();
            const salary_bank = $('select[name="salary_bank"]').val();
            const monthly_payments_bank = $('select[name="monthly_payments_bank"]').val();
            const nationality = $('select[name="nationality"]').val();

            if (!salary || !salary_bank || !monthly_payments_bank || !nationality) {
                // Ensure that we don't make a request with incomplete data
                return;
            }

            $.ajax({
                url: "{% url 'c7_motors:calculate_your_salary' %}",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    salary: salary,
                    salary_bank: salary_bank,
                    monthly_payments_bank: monthly_payments_bank,
                    nationality: nationality,
                    action: action
                }),
                headers: {
                    'X-CSRFToken': getCSRFToken()
                },
                success: function (response) {
                    // Update the DOM with the results
                    $('#downpayment').text(response.downpayment || "AED 0.00");
                    $('#monthly_installment_with_downpayment').text(response.monthly_with_dp || "AED 0.00");
                    $('#monthly_installment_without_downpayment').text(response.monthly_without_dp || "AED 0.00");
                    $('#annual_interest_rate').text(response.annual_interest || "AED 0.00");
                    $('#total_with_dp').text(response.total_with_dp || "AED 0.00");
                    $('#total_without_dp').text(response.total_without_dp || "AED 0.00");

                    // Remove or comment out the automatic redirect
                    // if (action === "pay_deposit") {
                    //     window.location.href = "/payment_in_installments/";
                    // } else if (action === "continue_without_dp") {
                    //     window.location.href = "/payment_in_installments_without_downpayment/";
                    // }
                },
                error: function (error) {
                    console.error("Error:", error.responseJSON || error.responseText);
                    alert("An error occurred. Please try again.");
                }
            });
        }

        // Event listener for input changes
        $('#salary, select[name="salary_bank"], select[name="monthly_payments_bank"], select[name="nationality"]').on('change', function () {
            // Optionally, you can set the action based on which field changed or use a default action.
            updateSalaryOverview("continue_without_dp");
        });

        // Button click event for redirection (if needed)
        $('#pay_deposit').on('click', function () {
            updateSalaryOverview("pay_deposit");
            window.location.href = "/payment_in_installments/";
        });

        $('#continue_without_dp').on('click', function () {
            updateSalaryOverview("continue_without_dp");
            window.location.href = "/payment_in_installments_without_downpayment/";
        });
    </script>
    
    <!-- JavaScript Libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'lib/wow/wow.min.js'%}"></script>
    <script src="{% static 'lib/easing/easing.min.js'%}"></script>
    <script src="{% static 'lib/waypoints/waypoints.min.js'%}"></script>
    <script src="{% static 'lib/counterup/counterup.min.js'%}"></script>
    <script src="{% static 'lib/owlcarousel/owl.carousel.min.js'%}"></script>
    <script src="{% static 'js/main1.js'%}"></script>
</body>
</html>

{% endblock %}