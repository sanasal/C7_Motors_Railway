{% block content %}
{% load static %}


<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <title>C7 Payment</title>
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta content="" name="keywords">
        <meta content="" name="description">

        <!-- Google Web Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,400;0,700;0,900;1,400;1,700;1,900&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet"> 

        <!-- Icon Font Stylesheet -->
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
        <link rel="icon" type="image/png" href="{% static 'img/c7_logo.png'%}">

        <!-- Libraries Stylesheet -->
        <link href="{% static 'lib/animate/animate.min.css'%}" rel="stylesheet">
        <link href="{% static 'lib/owlcarousel/assets/owl.carousel.min.css'%}" rel="stylesheet">


        <!-- Customized Bootstrap Stylesheet -->
        <link href="{% static 'css/bootstrap.min.css'%}" rel="stylesheet">

        <!-- Template Stylesheet -->
        <link href="{% static 'css/style.css'%}" rel="stylesheet">

        <!-- Crasual Styling -->
        <style>
            .carousel .carousel-item, .carousel .carousel-item img {
                height: 950px;
            }
            .row2 {
                --bs-gutter-x: 1.5rem;
                --bs-gutter-y: 0;
                display: flex;
                flex-wrap: wrap;
            }
        </style>
    </head>

    <body>

        <!-- Spinner Start -->
        <div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
            <div class="spinner-border" style="width: 3rem; height: 3rem; color:#e30a23" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
        <!-- Spinner End -->

        <!-- Topbar Start -->
        <div class="container-fluid topbar d-none d-xl-block w-100" style="background:#ffffff;">
            <div class="container">
                <div class="row gx-0 align-items-center" style="height: 45px;">
                    <div class="col-lg-6 text-center text-lg-start mb-lg-0">
                        <div class="d-flex flex-wrap">
                            <a class="text-muted me-4"><i class="fas fa-phone-alt me-2" style="color: #e30a23;"></i>+971562341000</a>
                            <a class="text-muted me-0"><i class="fas fa-envelope me-2" style="color: #e30a23;"></i>Csev7motors@gmail.com</a>
                        </div>
                    </div>
                    <div class="col-lg-6 text-center text-lg-end">
                        <div class="d-flex align-items-center justify-content-end">
                            <a href="https://www.tiktok.com/@_c7motors" class="btn btn-light btn-sm-square rounded-circle me-3"><i class="fab fa-tiktok"></i></a>
                            <a href="https://www.instagram.com/c.7.motors/" class="btn btn-light btn-sm-square rounded-circle me-3"><i class="fab fa-instagram"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Topbar End -->

        <!-- Navbar & Hero Start -->
        <div class="container-fluid nav-bar sticky-top px-0 px-lg-4 py-2 py-lg-0">
            <div class="container">
                <nav class="navbar navbar-expand-lg navbar-light">
                    <a href="{% url 'c7_motors:home' %}" class="navbar-logo p-0">
                        <img src="{% static 'img/c7_logo.png'%}" alt="">
                    </a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                        <span class="fa fa-bars"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarCollapse">
                        <div class="navbar-nav mx-auto py-0">
                            <a href="{% url 'c7_motors:home' %}" class="nav-item nav-link"><i class="bi bi-house-door"></i> Home</a>
                            <a href="{% url 'c7_motors:about' %}" class="nav-item nav-link"><i class="bi bi-info-circle"></i> About</a>
                            <a href="{% url 'c7_motors:service' %}" class="nav-item nav-link"><i class="bi bi-tools"></i> Service</a>
                            <a href="{% url 'c7_motors:feature' %}" class="nav-item nav-link"><i class="bi bi-star-fill"></i> Features</a>
                            <a href="{% url 'c7_motors:shopping_cart' %}" class="nav-item nav-link"><i class="bi bi-basket3"></i> My Cart</a>
                            <a class="nav-item nav-link" id="checkout-button" data-bs-toggle="modal" data-bs-target="#exampleModal" type="button"><i class="bi bi-cash"></i> Pay</a>
                            <a href="{% url 'c7_motors:contact_us' %}" class="nav-item nav-link"><i class="bi bi-telephone"></i> Contact</a>
                        </div>
                        {% if user.is_authenticated %}
                        <form action="/log_out/" method="post" class="main_nav">
                         {% csrf_token %}
                         <a class="btn rounded-pill py-2 px-4" style="background-color: #e30a23;"><button type="submit" class="btn" style="color: #ffffff;">Log out</button></a>
                        </form>
                        {% else %}
                        <a class="btn rounded-pill py-2 px-4" style="background-color: #e30a23;" href="{% url 'c7_motors:log_in'%}"><button type="submit" class="btn" style="color: #ffffff;">Log in</button></a>
                        <a class="btn rounded-pill py-2 px-4" style="background-color: #e30a23;" href="{% url 'c7_motors:sign_in'%}" style="margin-left: 20px;"><button type="submit" class="btn" style="color: #ffffff;">Sign in</button></a>
                        {% endif %}
                    </div>
                </nav>
            </div>
        </div>
        <!-- Navbar & Hero End -->
        
        <!-- Carousel Start -->
        <div class="header-carousel">
            <div id="carouselId" class="carousel slide" data-bs-ride="carousel" data-bs-interval="false">
                <div class="carousel-inner" role="listbox">
                    <div class="carousel-item active">
                        <img src="{% static 'img/car6.jpg'%}" class="img-fluid w-100" alt="First slide"/>
                        <div class="carousel-caption">
                            <div class="container py-4">
                                <div class="row2 g-5">
                                    <div class="col-lg-6 fadeInLeft animated" data-animation="fadeInLeft" data-delay="1s" style="animation-delay: 1s;">
                                        <div class="rounded p-5" style="background-color: rgb(24, 24, 24);">
                                            <form id="pay-form" action="add_installments_data_without_dp/" method="post" enctype="multipart/form-data">
                                                {% csrf_token %}
                                                
                                                <!-- Hidden Inputs to Pass Installment Data -->
                                                <input type="hidden" id="monthly_installment" name="monthly_installment" value="{{ monthly_without_dp }}">
                                                <input type="hidden" id="total_amount" name="total_amount" value="{{ total_without_dp }}">
                                            
                                                <div class="row g-3">
                                                    {% for item in items %}
                                                    <div class="col-12 input-group">
                                                        <input value="{{ item.car.brand_name }} {{ item.car.model }}"  id="cars" name="cars"  
                                                            class="form-select rounded-end" style="padding-right:0%;background-image: none;" readonly>
                                                        <i data-car-id="{{ item.car.id }}" style="color: #e30a23;" class="btn delete_item fas fa-trash"></i>
                                                    </div>
                                                    {% endfor %}
                                                    
                                                    <div class="col-12">
                                                        <input id="name" class="form-select" style="background-image: none;" name="name" placeholder="Name" required>
                                                    </div>
                                                    <div class="col-12">
                                                        <input id="email" class="form-select" style="background-image: none;" name="email" placeholder="Email" required>
                                                    </div>
                                                    <div class="col-12">
                                                        <input id="mobile_phone" class="form-select" style="background-image: none;" name="mobile_phone" placeholder="Mobile Phone" required>
                                                    </div>
                                            
                                                    <!-- File Upload Fields -->
                                                    <div class="col-12">
                                                        <div class="input-group">
                                                            <div class="d-flex align-items-center bg-light text-body rounded-start p-2">
                                                                <span class="fas fa-file-alt"></span> <span class="ms-1">Salary Certificate</span>
                                                            </div>
                                                            <input id="salary_certificate" type="file" class="form-control" name="salary_certificate" required>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="input-group">
                                                            <div class="d-flex align-items-center bg-light text-body rounded-start p-2">
                                                                <span class="fas fa-id-card"></span> <span class="ms-1">Personal ID Card</span>
                                                            </div>
                                                            <input id="personal_identification_card" type="file" class="form-control" name="personal_identification_card" required>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="input-group">
                                                            <div class="d-flex align-items-center bg-light text-body rounded-start p-2">
                                                                <span class="fas fa-passport"></span> <span class="ms-1">Passport</span>
                                                            </div>
                                                            <input id="passport" type="file" class="form-control" name="passport" required>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="input-group">
                                                            <div class="d-flex align-items-center bg-light text-body rounded-start p-2">
                                                                <span class="fas fa-id-badge"></span> <span class="ms-1">Driver's License</span>
                                                            </div>
                                                            <input id="driver_license" type="file" class="form-control" name="driver_license" required>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="input-group">
                                                            <div class="d-flex align-items-center bg-light text-body rounded-start p-2">
                                                                <span class="fas fa-file-invoice"></span> <span class="ms-1">Bank Statement</span>
                                                            </div>
                                                            <input id="bank_statement" type="file" class="form-control" name="bank_statement" required>
                                                        </div>
                                                    </div>                                   
                                            
                                                    <!-- Pickup Location & Date/Time -->
                                                    <div class="col-12">
                                                        <div class="input-group">
                                                            <div class="d-flex align-items-center bg-light text-body rounded-start p-2">
                                                                <span class="fas fa-map-marker-alt"></span> <span class="ms-1">Pick Up</span>
                                                            </div>
                                                            <input name="pick_up_location" class="form-control" type="text" placeholder="Enter a Location (Optional)">
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="input-group">
                                                            <div class="d-flex align-items-center bg-light text-body rounded-start p-2">
                                                                <span class="fas fa-calendar-alt"></span><span class="ms-1">Pick Up</span>
                                                            </div>
                                                            <input class="form-control" type="date" name="pick_up_date">
                                                            <input class="form-control ms-3" type="time" id="appt" name="pick_up_time">
                                                        </div>
                                                    </div>
                                            
                                                    <!-- Submit Button -->
                                                    <div class="col-12">
                                                        <button id="checkout-button" style="background-color: #e30a23; color:white;" class="btn w-100 py-2 mb-0" data-bs-toggle="modal" data-bs-target="#exampleModal" type="submit">Book your car and Pay<span id="deposit-price-display">3000 AED</span></button>
                                                    </div>
                                                </div>
                                            </form>
                                            
                                        </div>
                                    </div>
                                    <div class="col-lg-6 d-none d-lg-flex fadeInRight animated" data-animation="fadeInRight" data-delay="1s" style="animation-delay: 1s;">
                                        <div class="text-start">
                                            <h1 class="display-5 text-white" style="margin-left:15%; margin-top:30%;">Discover Your Perfect Ride with Our Premium Car Selection</h1>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div> 
        </div>
        <!-- Carousel End -->

        <!-- Model Start -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                <h1 class="modal-title" id="exampleModalLabel" style="color: #e30a23;">Welcome to<h1 class="modal-title" style="color: #323232;margin-left:5px">C</h1> <h1 class="modal-title" style="color: #e30a23;">7</h1></h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Please wait until return to checkout page
                </div>
            </div>
            </div>
        </div>
        <!-- Model End -->

        <!-- Footer Start -->
        <div class="container-fluid footer py-5 wow fadeIn" data-wow-delay="0.2s">
            <div class="container py-5">
                <div class="row g-5">
                    <div class="col-md-6 col-lg-6 col-xl-3">
                        <div class="footer-item d-flex flex-column">
                            <div class="footer-item">
                                <h4 class="text-white mb-4">About Us</h4>
                                <p class="mb-3">
                                    At C7 Motors, we are dedicated to making car ownership accessible and seamless. Our mission is to provide high-quality, pre-owned vehicles paired with exceptional customer service.
                                    We offer flexible payment options, including cash purchases and convenient installment plans, ensuring that everyone can find the right car for their needs. 
                                    At C7 Motors, our goal is to help you drive away with confidence and satisfaction.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-6 col-xl-3">
                        <div class="footer-item d-flex flex-column">
                            <h4 class="text-white mb-4">Quick Links</h4>
                            <a href="{% url 'c7_motors:about' %}"><i class="fas fa-angle-right me-2"></i> About</a>
                            <a href="{% url 'c7_motors:shopping_cart' %}"><i class="fas fa-angle-right me-2"></i> My Cart</a>
                            <a href="{% url 'c7_motors:contact_us' %}"><i class="fas fa-angle-right me-2"></i> Contact us</a>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-6 col-xl-3">
                        <div class="footer-item d-flex flex-column">
                            <h4 class="text-white mb-4">Business Hours</h4>
                            <div class="mb-3">
                                <h6 class="text-muted mb-0">We are open to serve you from 10:00 AM to 10:00 PM every day</h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-6 col-xl-3">
                        <div class="footer-item d-flex flex-column">
                            <h4 class="text-white mb-4">Contact Info</h4>
                            <a href="#"><i class="fa fa-map-marker-alt me-2"></i> 18th St -Al Quoz Industrial Area 1 - Dubai - United Arab Emirates</a>
                            <a href=""><i class="fas fa-envelope me-2"></i> Csev7motors@gmail.com</a>
                            <a href=""><i class="fas fa-phone me-2"></i> +971562341000</a>
                            <div class="d-flex">
                                <a class="btn btn-md-square rounded-circle me-3" href="https://www.tiktok.com/@_c7motors"><i class="fab fa-tiktok text-white"></i></a>
                                <a class="btn btn-md-square rounded-circle me-3" href="https://www.instagram.com/c.7.motors/"><i class="fab fa-instagram text-white"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Footer End -->

        <!-- Copyright Start -->
        <div class="container-fluid copyright py-4">
            <div class="container">
                <div class="row g-4 align-items-center">
                    <div class="col-md-6 text-center text-md-start mb-md-0">
                        <span class="text-body"><a href="#" class="border-bottom text-white"><i class="fas fa-copyright text-light me-2"></i>C7 Motors</a>, All right reserved.</span>
                    </div>
                    <div class="col-md-6 text-center text-md-start mb-md-0">
                        <span class="text-body"><a href="#" class="border-bottom text-white">Designed & Developed By Sana Salhdar</a> +963968678579</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Copyright End -->

        <!-- Back to Top -->
        <a href="#" class="btn btn-lg-square rounded-circle back-to-top" style="background-color: black;color:#ffffff"><i class="fa fa-arrow-up"></i></a>  
        
        <!-- JavaScript Libraries -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="{% static 'lib/wow/wow.min.js'%}"></script>
        <script src="{% static 'lib/easing/easing.min.js'%}"></script>
        <script src="{% static 'lib/waypoints/waypoints.min.js'%}"></script>
        <script src="{% static 'lib/counterup/counterup.min.js'%}"></script>
        <script src="{% static 'lib/owlcarousel/owl.carousel.min.js'%}"></script>
        <script src="https://js.stripe.com/v3/"></script>
        <script>
            //Protect function
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken'); 
            
            //Delete Items In The Customer Shopping Cart
            let delete_button = document.querySelectorAll('.delete_item')
            delete_button.forEach(btn => {
                btn.addEventListener('click' , deleteItem)
            })
            function deleteItem(e){
                let car_id = e.target.dataset.carId
                let url = '/delete/'
                let data = { id:car_id }
                
                fetch(url , {
                    method : 'POST' ,
                    headers : {"Content-Type" : "application/json" , "X-CSRFToken" : csrftoken} ,
                    body : JSON.stringify(data)
                }).then(res => res.json())
                .then(data => {
                    console.log(data)
                })
                .catch(error => {
                    console.log(error)
                })
                setTimeout(function() {
                    window.location.reload('https://c7-rental-cars-btcpdaf3eqg7czab.uaenorth-01.azurewebsites.net/log_in/?next=/Manage_Your_Book/'); 
                }, 200);
            }

            function addDataCustomers() {
                // Create a new FormData object
                var formData = new FormData(document.getElementById('pay-form'));
                
                // Add CSRF token to FormData
                var csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
                formData.append('csrfmiddlewaretoken', csrfToken);
            
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/add_installments_data_without_dp/', true);
            
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        var response = JSON.parse(xhr.responseText);
                        if (response.success) {
                            // Update the total price dynamically on the page
                            var totalPriceElement = document.getElementById('deposit-price-display');
                            if (totalPriceElement) {
                                totalPriceElement.textContent = response.paid_amount + "AED";
                            }
                        } else {
                            console.error('Error:', response.errors);
                        }
                    } else {
                        console.error('Error sending data:', xhr.status, xhr.statusText);
                    }
                };
            
                xhr.onerror = function () {
                    console.error('Request failed');
                };
            
                // Send the FormData with the CSRF token
                xhr.send(formData);
            }
            
            window.onload = function() {
                document.getElementById('pay-form').addEventListener('submit', function(event) {
                    
                    //Alert for deposit
                    alert('A request will be submitted to the bank, and in case of rejection, the deposit will not be refunded')

                    event.preventDefault();
                    addDataCustomers();
                     
                    // Initialize Stripe with the publishable key passed from Django
                    var stripe = Stripe('{{ STRIPE_PUBLISHABLE_KEY }}');  
                
                    // Assign total_price from the Django template to a JavaScript variable
                    var totalPrice = "{{ stripe_deposit }}";  // This will be output as a string
                
                    // Convert the string to a number (in case it's a decimal or string)
                    var totalPriceFloat = parseFloat(totalPrice);

                    fetch('/create-installments-checkout-session/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}',  // Include CSRF token for security
                        },
                        body: JSON.stringify({
                            total_price: totalPriceFloat  // Pass the correctly parsed total price as a number
                        }),
                    })
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(session) {
                        // Redirect to the Stripe Checkout session
                        return stripe.redirectToCheckout({ sessionId: session.id });
                    })
                    .then(function(result) {
                        if (result.error) {
                            // If there's an error, alert the user
                            alert(result.error.message);
                        }
                    })
                    .catch(function(error) {
                        console.error('Error:', error);
                    });
                    });
            };
        </script>
        
        <!-- Template Javascript -->
        <script src="{% static 'js/main1.js'%}"></script>
    </body>

</html>

{% endblock %}