{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block meta %}
        <title>{{ car.brand_name }} {{ car.model }} {{ car.model_year }} {% trans "for Sale | C7 Motors" %}</title>
        <meta name="description" content="{% trans 'Buy a used' %} {{ car.brand_name }} {{ car.model }} {{ car.model_year }} {% trans 'in excellent condition. Low mileage, affordable price, and great financing options available. Contact us today!' %}" />
        <meta name="keywords" content="{{ car.brand_name }} {{ car.model }} {{ car.model_year }} {% trans 'for sale, buy used' %} {{ car.brand_name }} {{ car.model }}{% trans ', best price' %} {{ car.brand_name }} {{ car.model }}{% trans ', low mileage' %} {{ car.model }}" />

        <!-- Template Stylesheet -->
        <link rel="stylesheet" href="{% static 'css/owl.carousel.min.css'%}">
        <link rel="stylesheet" href="{% static 'css/owl.theme.default.min.css'%}">
		<link rel="stylesheet" href="{% static 'css/animate.css'%}">
		<link rel="stylesheet" href="{% static 'css/style4.css'%}">

        <!-- Styling -->
        <style>
            /* card responsive styling */
            @media (max-width: 576px) {
                .card {
                    margin-top: 20px;
                }
            } 
            
            .more-text {
                display: none;
            }
            
            .more-text.show {
                display: inline;
            }


            
            /* descrption styling */
            .desc-section { 
                padding-left: 0%;
                padding-right: 0%;
                padding-top: 0%;
                padding-bottom: 7em;
            }

            .description:has(.more-text.show) {
                -webkit-line-clamp: unset;
                max-height: none;
                overflow: visible;
            }


            .work .img {
                width: 100%;
                height: auto;
                position: relative;
                z-index: 0;
                border-radius: 10px;
                overflow: hidden;
                -webkit-box-shadow: 0px 20px 35px -30px rgba(0, 0, 0, 0.26);
                -moz-box-shadow: 0px 20px 35px -30px rgba(0, 0, 0, 0.26);
                box-shadow: 0px 20px 35px -30px rgba(0, 0, 0, 0.26);
            }   

            .carousel-prev,
            .carousel-next {
                background: rgba(0, 0, 0, 0.6);
                color: white;
                border: none;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 26px;
                cursor: pointer;
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                z-index: 10;
                pointer-events: auto;
                transition: background 0.3s;
            }

            .carousel-prev:hover,
            .carousel-next:hover {
                background: rgba(0, 0, 0, 0.9);
            }

            .carousel-prev {
                left: 20px;
            }

            .carousel-next {
                right: 20px;
            }

            .preformatted-text {
                white-space: pre-wrap;
            }

            .description {
                display: -webkit-box;
                -webkit-line-clamp: 3;   
                -webkit-box-orient: vertical;
                overflow: hidden;
                text-overflow: ellipsis;
                max-height: 4.5em;
            }

            .description.expanded {
                -webkit-line-clamp: unset;
                max-height: none;
            }

            .read-more-button{
                position: relative;
                left: 150px;
                color: #e30a23;

            }

            .mobile-card .price-badge{
                position:absolute; left:12px; bottom:12px; z-index:3;
                background:#fff; border-radius:8px; padding:6px 10px; font-weight:700;
                }
                .mobile-card .carousel-indicators [data-bs-target] {
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    background-color: #999;
                }
                .mobile-card .carousel-indicators .active {
                    background-color: #e30a23;
                }

        </style>
{% endblock %}
{% block content %}
        <!-- Mobile Car Images Slider and Details Start -->
        <div class="card shadow d-block d-md-none mobile-card" 
            style="border-radius:7px; overflow:hidden; position:relative; margin:3px; margin-bottom:100px;" data-bs-touch="true">
                <!-- كـاروسيل الصور -->
                <div id="carCarousel{{ car.id }}" class="carousel slide" data-bs-ride="carousel" data-bs-touch="true" style="height: 350px;">
                    <div class="carousel-inner">
                        {% for image in car_images %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            <img src="{{ image.image.url }}" class="d-block w-100" 
                                alt="{{ car.brand_name }} {{ car.model }}" 
                                style="height:300px; object-fit:cover;">
                        </div>
                        {% empty %}
                        <div class="carousel-item active">
                            <img src="{% static 'img/placeholder.webp' %}" class="d-block w-100" 
                                alt="No image" 
                                style="height:200px; object-fit:cover;">
                        </div>
                        {% endfor %}
                    </div>

                    <!-- أزرار التنقل -->
                    <button class="carousel-control-prev" type="button" data-bs-target="#carCarousel{{ car.id }}" data-bs-slide="prev" style="color: black;">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">{% trans "Previous" %}</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carCarousel{{ car.id }}" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">{% trans "Next" %}</span>
                    </button>
                <!-- السعر فوق الصور -->
                <div class="price-badge" 
                    style="color:#e30a23; position:absolute; left:12px; bottom:40px; 
                            background:#fff; padding:6px 12px; border-radius:10px; 
                            font-weight:bold; z-index:2;">
                    {% trans "AED" %} {{ car.cash_price }}
                </div>
            </div>

            <!-- تفاصيل تحت الصور -->
            <div class="card-body">
                <h5 class="card-title fw-bold mb-1 text-uppercase">{{ car.brand_name }} {{ car.model }}</h5>
                <p class="text-muted mb-2">{{ car.model_year }}</p>
                <ul class="list-inline small mb-3">
                    <li class="list-inline-item"><i class="bi bi-speedometer2"></i> {{ car.mileage }} {% trans "km" %}</li>
                    <li class="list-inline-item"><i class="bi bi-gear"></i> {{ car.transmission }}</li>
                    <li class="list-inline-item"><i class="bi bi-globe2"></i> {{ car.specification }}</li>
                </ul>
                <div class="row g-0 border-bottom border-top"></div>
                <div>
                    <h5 class="card-title fw-bold mb-3 text-uppercase mt-4">{% trans "Car Overview" %}</h5>
                    <div class="col-6" style="text-align: start;">
                        <ul class="list-unstyled mb-0" style="color: rgb(59, 56, 56);">
                            <li class="mb-3 bold" style="white-space: nowrap;"><strong class="mx-3">{% trans "Exterior" %}</strong> {{ car.exterior_color }}</li>
                            <li class="mb-3 bold" style="white-space: nowrap;"><strong class="mx-3">{% trans "Interior" %}</strong> {{ car.interior_color }}</li>
                            <li class="mb-3 bold" style="white-space: nowrap;"><strong class="mx-3">{% trans "Horsepower" %}</strong> {{ car.horsepower }}{% trans "HP" %}</li>
                            <li class="mb-3 bold" style="white-space: nowrap;"><strong class="mx-3">{% trans "Spec" %}</strong> {{ car.specification }}</li>
                            <li class="mb-3 bold" style="white-space: nowrap;"><strong class="mx-3">{% trans "Seats" %}</strong> {{ car.seating_capacity }}</li>
                            <li class="mb-3 bold" style="white-space: nowrap;"><strong class="mx-3">{% trans "Cylinders" %}</strong> {{ car.cylinders }}</li>
                            <li class="mb-3 bold" style="white-space: nowrap;"><strong class="mx-3">{% trans "Engine" %}</strong> {{ car.engine_capacity }}{% trans "cc" %}</li>
                            <li class="mb-3 bold" style="white-space: nowrap;"><strong class="mx-3">{% trans "Installment" %}</strong> {{ car.monthly_installments_price }} {% trans "AED" %}</li>
                        </ul>
                    </div>
                </div>

                <a href="{% url 'c7_motors:get_it_now' car_id=car.id %}" 
                class="btn w-100 fw-semibold mt-3" 
                style="background:#e30a23; color:#fff; border-radius:10px;">
                {% trans "Get It Now" %}
                </a>
            </div>
        </div>
        <!-- Mobile Car Images Slider and Details End -->


        <!-- Desktop Car Images Slider and Details Start -->
        <div class="desktop-view d-none d-md-block">
            <section class="ftco-section pt-5">
                <div class="container">
                    <div class="row">
                        <!-- Images Slider -->
                        <div class="col-lg-7 col-md-12 order-1 order-lg-1">
                            <div class="slider-hero position-relative">
                                <div class="featured-carousel owl-carousel">
                                    {% for image in car_images %}
                                    <div class="item">
                                        <div class="work">
                                            <img src="{{ image.image.url }}" class="img d-flex align-items-center justify-content-center" style="width:100%; height:400px; object-fit:cover;">
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <!-- Navigation Arrows -->
                                <button class="carousel-prev">&lt;</button>
                                <button class="carousel-next">&gt;</button>
                            </div>
                        </div>
            
                        <div class="col-lg-5 col-md-12 order-2 order-lg-2 d-flex justify-content-center align-items-center">
                            <div class="card shadow rounded-4 border-0" style="width: 100%; max-width: 26rem;">
            
                            <!-- Header -->
                            <div class="card-body text-center pb-0">
                                <h4 class="card-title fw-bold mb-1">{{ car.brand_name }} {{ car.model }}</h4>
                                <p class="text-muted">{{ car.model_year }}</p>
                            </div>
                        
                            <!-- Info Grid with Divider -->
                            <div class="row g-0 border-bottom border-top">
                                <!-- Left Column -->
                                <div class="col-6 p-3">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-2" style="white-space: nowrap;"><strong>{% trans "Mileage:" %}</strong> {{ car.mileage }} {% trans "Km" %}</li>
                                    <li class="mb-2" style="white-space: nowrap;"><strong>{% trans "Exterior:" %}</strong> {{ car.exterior_color }}</li>
                                    <li class="mb-2" style="white-space: nowrap;"><strong>{% trans "Interior:" %}</strong> {{ car.interior_color }}</li>
                                    <li class="mb-2" style="white-space: nowrap;"><strong>{% trans "Transmission:" %}</strong> {{ car.transmission }}</li>
                                    <li class="mb-2" style="white-space: nowrap;"><strong>{% trans "Horsepower:" %}</strong> {{ car.horsepower }}{% trans "HP" %}</li>
                                    <li class="mb-2" style="white-space: nowrap;"><strong>{% trans "Spec:" %}</strong> {{ car.specification }}</li>
                                </ul>
                                </div>
                        
                                <!-- Divider Column -->
                                <div class="col-1 d-none d-md-block border-start"></div>
                        
                                <!-- Right Column -->
                                <div class="col-4 p-3 d-flex align-items-start" style="margin-left:-30px;">
                                    <ul class="list-unstyled mb-0 w-100">
                                        <li class="mb-2" style="white-space: nowrap;"><strong>{% trans "Seats:" %}</strong> {{ car.seating_capacity }}</li>
                                        <li class="mb-2" style="white-space: nowrap;"><strong>{% trans "Cylinders:" %}</strong> {{ car.cylinders }}</li>
                                        <li class="mb-2" style="white-space: nowrap;"><strong>{% trans "Engine:" %}</strong> {{ car.engine_capacity }}{% trans "cc" %}</li>
                                        <li class="mb-2" style="white-space: nowrap;"><strong>{% trans "Price:" %}</strong>{{ car.cash_price }} {% trans "AED" %}</li>
                                        <li class="mb-2" style="white-space: nowrap;"><strong>{% trans "Installment:" %}</strong>{{ car.monthly_installments_price }} {% trans "AED" %}</li>
                                    </ul>
                                </div>
                            </div>
                        
                            <!-- CTA Button -->
                            <div class="card-body pt-3">
                                <a href="{% url 'c7_motors:get_it_now' car_id=car.id %}" class="btn w-100 fw-semibold py-2"
                                style="background-color: #e30a23; color: white; border-radius: 8px;">
                                {% trans "Get It Now" %}
                                </a>
                            </div>
                        
                            </div>
                        </div>                      
                        
                    </div>
                </div>
            </section>  
        </div>
        <div class="container mt-0" style="margin-bottom: 70px;">
            <div class="card-body" style="margin-bottom:120px">
                <h5 class="fw-bold mb-3" style="font-size: 27px;">
                    {{ car.brand_name }} {{ car.model }} {{ car.model_year }}
                </h5>
            
                <p class="card-text description">
                    <span>
                        {{ car.description|truncatechars:200|linebreaksbr }}
                    </span>
                    
                    <span class="more-text">
                        {{ car.description|slice:"200:"|linebreaksbr }}
                    </span>
                </p>
            
                <a href="javascript:void(0);"
                   onclick="toggleReadMore(this)"
                   class="btn fw-semibold read-more-button"
                   data-more-text="{% trans 'Read More' %}"
                   data-less-text="{% trans 'Read Less' %}"
                   style="width: 200px;">
                    {% trans "Read More" %}
                </a>
            </div>


            <!-- Drivers Assistance & Safety -->
            {% if technical_features %}
            <h5 class="fw-bold mb-3">{% trans "Technical Features" %}</h5>
            <div class="row">
                {% for feature in technical_features %}
                <div class="col-md-6 col-lg-4 mb-2">
                    <span class="text-success fw-bold">✓</span> {{ feature.name }}
                </div>
                {% endfor %}
            </div>
            <hr class="my-4">
            {% endif %}
            
            {% if comfort_and_convenience %}
            <!-- Drivers Assistance & Safety -->
            <h5 class="fw-bold mb-3">{% trans "Comfort & Convenience" %}</h5>
            <div class="row">
                {% for feature in comfort_and_convenience %}
                <div class="col-md-6 col-lg-4 mb-2">
                    <span class="text-success fw-bold">✓</span> {{ feature.name }}
                </div>
                {% endfor %}
            </div>
            <hr class="my-4">
            {% endif %}
            
            {% if exterior %}
            <!-- Drivers Assistance & Safety -->
            <h5 class="fw-bold mb-3">{% trans "Exterior" %}</h5>
            <div class="row">
                {% for feature in exterior %}
                <div class="col-md-6 col-lg-4 mb-2">
                    <span class="text-success fw-bold">✓</span> {{ feature.name }}
                </div>
                {% endfor %}
            </div>
            <hr class="my-4">
            {% endif %}
            
            {% if driver_assistance_and_safty %}
            <!-- Drivers Assistance & Safety -->
            <h5 class="fw-bold mb-3">{% trans "Driver Assistance & Safty" %}</h5>
            <div class="row">
                {% for feature in driver_assistance_and_safty %}
                <div class="col-md-6 col-lg-4 mb-2">
                    <span class="text-success fw-bold">✓</span> {{ feature.name }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            
        </div>
        <!-- Desktop Car Images Slider and Details End -->

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{% static 'js/owl.carousel.min.js' %}"></script>
    <script>
        //protect the site by cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        document.querySelectorAll('.carousel').forEach(function (carousel) {
        let startX = 0;
        let endX = 0;

        carousel.addEventListener('touchstart', function (e) {
            startX = e.touches[0].clientX;
        });

        carousel.addEventListener('touchmove', function (e) {
            endX = e.touches[0].clientX;
        });

        carousel.addEventListener('touchend', function () {
            let diffX = startX - endX;
            if (Math.abs(diffX) > 50) { // عشان ما يتقلب إلا لو السحب قوي شوي
            if (diffX > 0) {
                bootstrap.Carousel.getInstance(carousel).next();
            } else {
                bootstrap.Carousel.getInstance(carousel).prev();
            }
            }
        });
        });

        (function ($) {
            "use strict";
        
            var owl = $('.featured-carousel');
        
            // Initialize Owl Carousel
            owl.owlCarousel({
                animateOut: 'fadeOut',
                center: false,
                items: 1,
                loop: true,
                stagePadding: 0,
                margin: 0,
                smartSpeed: 1500,
                autoplay: false,
                dots: false,
                nav: false
            });
        
            // Add event listeners to the custom navigation buttons
            $('.carousel-prev').click(function () {
                owl.trigger('prev.owl.carousel');
            });
        
            $('.carousel-next').click(function () {
                owl.trigger('next.owl.carousel');
            });
        })(jQuery);

    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}